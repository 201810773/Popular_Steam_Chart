<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Django Highcharts -  RaceBarChart</title>
</head>
<body>
    <script src="https://code.highcharts.com/highcharts.js"></script>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <div id="play-controls">
        <button id="play-pause-button" class="fa fa-play" title="play"></button>
        <input id="play-range" type="range" value="0418" min="0401" max="0430" />
    </div>
    <!-- RankByTagAPIView에서 보낸 데이터를 가져옴 -->
    <div id="container" data-url="{% url 'tag_api' %}"></div>

    <script>
        function getData(year) {
            const output = Object.entries(dataset)
                .map(country => {
                    const [countryName, countryData] = country;
                    return [countryName, Number(countryData[year])];
                })
                .sort((a, b) => b[1] - a[1]);
            return [output[0], output.slice(1, nbr)];
        }
        

        $.ajax({
            url: $("#container").attr("data-url"),
            dataType: 'json',
            success: function (data) {
                chart = Highcharts.chart('container', {
                    chart: {
                        animation: {
                            duration: 500
                        },
                        marginRight: 50
                    },
                    title: {
                        text: 'World population by country',
                        align: 'left'
                    },
            
                    legend: {
                        enabled: false
                    },
                    xAxis: {
                        type: 'category'
                    },
                    yAxis: {
                        opposite: true,
                        tickPixelInterval: 150,
                        title: {
                            text: null
                        }
                    },
                    plotOptions: {
                        series: {
                            animation: false,
                            groupPadding: 0,
                            pointPadding: 0.1,
                            borderWidth: 0,
                            colorByPoint: true,
                            dataSorting: {
                                enabled: true,
                                matchByName: true
                            },
                            type: 'bar',
                            dataLabels: {
                                enabled: true
                            }
                        }
                    },
                    series: [
                        {
                            type: 'bar',
                            name: startYear,
                            data: getData(startYear)[1]
                        }
                    ],
                    responsive: {
                        rules: [{
                            condition: {
                                maxWidth: 550
                            },
                            chartOptions: {
                                xAxis: {
                                    visible: false
                                },
                                subtitle: {
                                    x: 0
                                },
                                plotOptions: {
                                    series: {
                                        dataLabels: [{
                                            enabled: true,
                                            y: 8
                                        }, {
                                            enabled: true,
                                            format: '{point.name}',
                                            y: -8,
                                            style: {
                                                fontWeight: 'normal',
                                                opacity: 0.7
                                            }
                                        }]
                                    }
                                }
                            }
                        }]
                    }
                });    
            }
        });

        function pause(button) {
            button.title = 'play';
            button.className = 'fa fa-play';
            clearTimeout(chart.sequenceTimer);
            chart.sequenceTimer = undefined;
        }

        function update(increment) {
            if (increment) {
                input.value = parseInt(input.value, 10) + increment;
            }
            if (input.value >= endYear) {
                // Auto-pause
                pause(btn);
            }
        
            chart.update(
                {
                    subtitle: {
                        text: getSubtitle()
                    }
                },
                false,
                false,
                false
            );
        
            chart.series[0].update({
                name: input.value,
                data: getData(input.value)[1]
            });
        }
        function play(button) {
            button.title = 'pause';
            button.className = 'fa fa-pause';
            chart.sequenceTimer = setInterval(function () {
                update(1);
            }, 500);
        }
        
        btn.addEventListener('click', function () {
            if (chart.sequenceTimer) {
                pause(this);
            } else {
                play(this);
            }
        });
        /*
         * Trigger the update on the range bar click.
         */
        input.addEventListener('click', function () {
            update();
        });
    </script>

    <div id="container1" data-url="{% url 'tag_api' %}"></div>

    <script>
        $.ajax({
            url: $("#container1").attr("data-url"),
            dataType: 'json',
            success: function (data) {
                Highcharts.chart('container1', {
                    chart: {
                        type: 'variablepie'
                    },
                    title: {
                        text: 'Popular categories compared by negative reviews'
                    },
                    tooltip: {
                        headerFormat: '',
                        pointFormat: '<span style="color:{point.color}">\u25CF</span> <b> {point.name}</b><br/>' +
                            'Total Reviews : <b>{point.y}</b><br/>' +
                            'Negative Reviews : <b>{point.z}</b><br/>'
                    },
                    plotOptions: {
                        series: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            // category 이름을 보여주는 기능
                            dataLabels: [{
                                enabled: true,
                                distance: 40
                            }, {
                                // percentage를 보여주는 기능
                                enabled: true,
                                distance: 0,
                                format: '{point.percentage:.1f}%',
                                style: {
                                    fontSize: '1em',
                                    textOutline: 'none',
                                    opacity: 0.7
                                },
                                // value값보다 작은 percentage는 보여주지 않는다.
                                filter: {
                                    operator: '>',
                                    property: 'percentage',
                                    value: 5
                                }
                            }]
                        }
                    },
                    series: [{
                        minPointSize: 10,
                        innerSize: '20%',
                        zMin: 0,
                        name: 'reviews',
                        borderRadius: 5,
                        data: data.neg
                        
                    }]
                });        
            }
        });
    </script>

</body>
</html>